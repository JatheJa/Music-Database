<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Artist Reviews</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background:#fafafa; }
    .container { max-width: 980px; margin: 0 auto; }
    .header { background:#fff; padding:16px; border-radius:10px; box-shadow: 0 2px 6px rgba(0,0,0,.08); display:flex; gap:16px; align-items:flex-start; }
    .header img { width:140px; height:140px; object-fit:cover; border-radius:10px; background:#eee; }
    .meta h1 { margin:0 0 6px 0; }
    .meta p { margin: 6px 0; color:#444; }
    .badge { display:inline-block; background:#0d6efd; color:#fff; padding:4px 8px; border-radius:999px; font-size:12px; }
    .reviews { margin-top: 18px; display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:14px; }
    .card { background:#fff; padding:12px; border-radius:10px; box-shadow: 0 2px 6px rgba(0,0,0,.06); display:flex; flex-direction:column; gap:8px; }
    .track { display:flex; gap:10px; }
    .track img { width:72px; height:72px; object-fit:cover; border-radius:8px; background:#eee; }
    .track .tmeta { flex:1; }
    .tmeta .title { font-weight:700; }
    .tmeta .sub { font-size: 12px; color:#555; }
    .stars { color:#e0a800; font-size: 16px; }
    .desc { font-size: 14px; color:#333; }
    .nav { margin-top:14px; }
    .nav a { text-decoration:none; color:#0d6efd; }
    .rowend { display:flex; justify-content:space-between; align-items:center; gap:8px; }
    button { cursor:pointer; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header" id="artistHeader">
      <img id="artistPic" alt="Artist picture" />
      <div class="meta">
        <h1 id="artistName"></h1>
        <p id="artistDesc"></p>
        <span class="badge" id="reviewCount"></span>
      </div>
    </div>

    <div class="reviews" id="reviewsGrid"></div>

    <div class="nav">
      <a id="backLink" href="selectreview.html">← Back to artist selection</a> •
      <a href="musicreview.html">Write a review</a>
    </div>
  </div>

  <script>
    const qs = new URL(location.href).searchParams;
    const artistId = qs.get("artistId");

    function stars(n){ n = Math.max(1, Math.min(5, n|0)); return "★".repeat(n) + "☆".repeat(5-n); }

    async function getMe(){
      const r = await fetch("/me", { credentials: "include" });
      return r.json();
    }
    async function getReviews(){
      const r = await fetch(`/artists/${encodeURIComponent(artistId)}/reviews`, { credentials: "include" });
      if(!r.ok) throw new Error("failed to load reviews");
      return r.json();
    }
    async function delReview(id){
      const r = await fetch(`/reviews/${id}`, { method:"DELETE", credentials:"include" });
      if(!r.ok){ const e = await r.json().catch(()=>({})); throw new Error(e.error||"delete failed"); }
      return r.json();
    }

    (async ()=>{
      if(!artistId){
        document.getElementById('artistHeader').innerHTML = '<div class="meta"><h1>No artistId</h1><p>Open from your selection page with ?artistId=...</p></div>';
        return;
      }

      const [me, reviews] = await Promise.all([getMe(), getReviews()]);

      if(reviews.length === 0){
        document.getElementById('artistHeader').innerHTML = '<div class="meta"><h1>No reviews yet</h1><p>Be the first to write one.</p></div>';
        return;
      }

      const a = reviews[0];
      document.getElementById('artistName').textContent = `${a.artist_name} (${a.artist_id})`;
      document.getElementById('artistDesc').textContent = a.artist_description || '';
      const img = document.getElementById('artistPic');
      img.src = a.artist_picture || '';
      img.style.display = a.artist_picture ? 'block':'none';
      document.getElementById('reviewCount').textContent = `${reviews.length} review(s), avg ${(
        reviews.reduce((s,r)=> s + (r.star_rating||0), 0) / reviews.length
      ).toFixed(1)} ★`;

      const grid = document.getElementById('reviewsGrid');
      grid.innerHTML = '';
      for(const r of reviews){
        const card = document.createElement('div');
        card.className = 'card';

        const track = document.createElement('div');
        track.className = 'track';
        const art = document.createElement('img');
        art.alt = 'Track artwork';
        art.src = r.track_artwork || '';
        if(!r.track_artwork) art.style.display = 'none';

        const tmeta = document.createElement('div');
        tmeta.className = 'tmeta';
        const ttitle = document.createElement('div');
        ttitle.className = 'title';
        ttitle.textContent = r.track_title || '(track)';
        const tsub = document.createElement('div');
        tsub.className = 'sub';
        tsub.textContent = `${r.artist_name} • ${r.album_title || ''} • ${r.track_length || ''}`;
        tmeta.appendChild(ttitle);
        tmeta.appendChild(tsub);
        track.appendChild(art);
        track.appendChild(tmeta);

        const rtitle = document.createElement('div');
        rtitle.style.fontWeight = '700';
        rtitle.textContent = r.review_title;

        const rating = document.createElement('div');
        rating.className = 'stars';
        rating.title = `${r.star_rating}/5`;
        rating.textContent = stars(r.star_rating);

        const desc = document.createElement('div');
        desc.className = 'desc';
        desc.textContent = r.review_description;

        const footer = document.createElement('div');
        footer.className = 'rowend';
        const left = document.createElement('div');
        left.style.fontSize = '12px';
        left.style.color = '#555';
        left.textContent = `Reviewer: ${r.username} (user #${r.user_id})`;
        footer.appendChild(left);

        if(me && me.id === r.user_id){
          const delBtn = document.createElement('button');
          delBtn.textContent = 'Delete';
          delBtn.onclick = async ()=>{
            if(!confirm('Delete this review?')) return;
            try { await delReview(r.id); location.reload(); }
            catch(e){ alert(e.message); }
          };
          footer.appendChild(delBtn);
        }

        card.appendChild(track);
        card.appendChild(rtitle);
        card.appendChild(rating);
        card.appendChild(desc);
        card.appendChild(footer);
        grid.appendChild(card);
      }
    })();
  </script>
</body>
</html>
